name: Configure Hugo Settings

on:
  workflow_run:
    workflows: ["Add Front Matter"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: read

jobs:
  configure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure Hugo
        id: config
        env:
          HUGO_CONFIG: |
            baseURL = "https://__DOMAIN__"
            languageCode = "zh-cn"
            title = "__OWNER__'s Space"
            theme = "PaperMod"
            [params]
            mainSections = ["post"]
            defaultTheme = "auto"
            ShowReadingTime = true
            ShowShareButtons = false
            ShowPostNavLinks = true
            ShowBreadCrumbs = true
            ShowCodeCopyButtons = true
            ShowToc = true
            [params.homeInfoParams]
            Title = "欢迎来到 __OWNER__ 的文档站"
            Content = "在喧嚣时代中静心思考，用文字传递理性与希望。"
            [[params.socialIcons]]
            name = "github"
            url = "https://github.com/__OWNER__"
            [outputs]
            home = ["HTML", "RSS", "JSON"]
            [taxonomies]
            category = "categories"
            tag = "tags"
            [menu]
            main = [
            {identifier = "archives", name = "Archives", url = "/archives/", weight = 10},
            {identifier = "categories", name = "Categories", url = "/categories/", weight = 20},
            {identifier = "search", name = "Search", url = "/search/", weight = 30},
            {identifier = "tags", name = "Tags", url = "/tags/", weight = 40}
            ]
        run: |
          # 获取域名
          domain=$(curl -sH "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pages \
            | jq -r '.cname // empty || "${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}"')

          # 创建或更新配置
          mkdir -p .github
          echo "$HUGO_CONFIG" | sed -e "s|__DOMAIN__|$domain|g" \
                                   -e "s|__OWNER__|${GITHUB_REPOSITORY_OWNER}|g" \
                                   > .github/hugo.toml

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/hugo.toml
          git diff-index --quiet HEAD || git commit -m "chore: update hugo config [skip ci]" && git push
